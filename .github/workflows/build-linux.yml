name: Build Linux Binary

on:
    outputs:
      artifact_name:
        description: "Name of the Linux binary artifact"
        value: ${{ jobs.build-linux-universal.outputs.artifact_name }}
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux-universal:
    name: Build Linux Binary (Universal - Ubuntu 22.04)
    runs-on: ubuntu-22.04
    outputs:
      artifact_name: ${{ steps.build.outputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb python3-tk libxcb-xinerama0 libxcb-cursor0 binutils
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install . pyinstaller
      - name: Prepare client_secrets.json
        shell: bash
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          SHA: ${{ github.sha }}
        run: |
          python -c "import os; v=open('src/opendata/VERSION').read().strip(); open('src/opendata/VERSION', 'w').write(f'{v}+{os.environ[\"SHA\"][:7]}')"
          if [ -n "$GOOGLE_CLIENT_ID" ] && [ -n "$GOOGLE_CLIENT_SECRET" ]; then
            echo "{\"installed\":{\"client_id\":\"$GOOGLE_CLIENT_ID\",\"project_id\":\"opendata-tool\",\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\"token_uri\":\"https://oauth2.googleapis.com/token\",\"auth_provider_x509_cert_url\":\"https://www.googleapis.com/oauth2/v1/certs\",\"client_secret\":\"$GOOGLE_CLIENT_SECRET\",\"redirect_uris\":[\"http://localhost\"]}}" > client_secrets.json
          fi
      - name: Build Universal Binary
        id: build
        run: |
          pyinstaller --onefile --name opendata-linux \
            --add-data "src/opendata/ui:opendata/ui" \
            --add-data "src/opendata/prompts:opendata/prompts" \
            --add-data "src/opendata/VERSION:." \
            --add-data "client_secrets.json:." \
            --exclude-module matplotlib --exclude-module PyQt5 --exclude-module PyQt6 --exclude-module PySide2 --exclude-module PySide6 --exclude-module IPython --exclude-module PIL \
            src/opendata/main.py
          echo "artifact_name=opendata-linux" >> $GITHUB_OUTPUT
      - name: Test Binary
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1280x1024x24 &
          sleep 2
          ./dist/opendata-linux --headless --port 8080 &
          sleep 15
          if curl -s http://127.0.0.1:8080 > /dev/null; then
            echo "✅ Universal Linux binary works (Ubuntu 22.04 build)"
          else
            echo "❌ Binary failed"
            exit 1
          fi
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: opendata-linux
          path: dist/opendata-linux
