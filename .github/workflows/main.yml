name: OpenData Tool CI/CD

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  # For PRs and branch pushes: run tests directly
  run-unit-tests:
    if: github.event_name == 'pull_request' || !startsWith(github.ref, 'refs/tags/')
    uses: ./.github/workflows/test-unit.yml

  run-gui-tests:
    if: github.event_name == 'pull_request' || !startsWith(github.ref, 'refs/tags/')
    uses: ./.github/workflows/test-gui.yml

  # For tags: run full release pipeline
  build-linux:
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/build-linux.yml
    secrets: inherit

  build-windows-macos:
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/build-windows-macos.yml
    secrets: inherit

  test-linux-binary:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux]
    uses: ./.github/workflows/test-linux-binary.yml

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-windows-macos, test-linux-binary]
    uses: ./.github/workflows/release.yml
    secrets: inherit
