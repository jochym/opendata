name: Build Windows & macOS Binaries

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows-macos:
    name: Build Binary (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: opendata-win
          - os: macos-latest
            artifact_name: opendata-macos-arm
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install . pyinstaller
      - name: Prepare client_secrets.json
        shell: bash
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          SHA: ${{ github.sha }}
        run: |
          python -c "import os; v=open('src/opendata/VERSION').read().strip(); open('src/opendata/VERSION', 'w').write(f'{v}+{os.environ[\"SHA\"][:7]}')"
          if [ -n "$GOOGLE_CLIENT_ID" ] && [ -n "$GOOGLE_CLIENT_SECRET" ]; then
            echo "{\"installed\":{\"client_id\":\"$GOOGLE_CLIENT_ID\",\"project_id\":\"opendata-tool\",\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\"token_uri\":\"https://oauth2.googleapis.com/token\",\"auth_provider_x509_cert_url\":\"https://www.googleapis.com/oauth2/v1/certs\",\"client_secret\":\"$GOOGLE_CLIENT_SECRET\",\"redirect_uris\":[\"http://localhost\"]}}" > client_secrets.json
          fi
      - name: Build with PyInstaller
        shell: bash
        run: |
          SEP=":"
          [[ "${{ runner.os }}" == "Windows" ]] && SEP=";"
          pyinstaller --noconsole --onefile --name "${{ matrix.artifact_name }}" \
            --add-data "src/opendata/ui${SEP}opendata/ui" \
            --add-data "src/opendata/prompts${SEP}opendata/prompts" \
            --add-data "src/opendata/VERSION${SEP}." \
            --add-data "client_secrets.json${SEP}." \
            --exclude-module matplotlib --exclude-module PyQt5 --exclude-module PyQt6 --exclude-module PySide2 --exclude-module PySide6 --exclude-module IPython --exclude-module PIL \
            src/opendata/main.py
      - name: Test Binary with API Verification
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            ./dist/${{ matrix.artifact_name }}.exe --headless --port 8080 &
          else
            ./dist/${{ matrix.artifact_name }} --headless --port 8080 &
          fi
          sleep 15
          
          # Test 1: Basic HTTP response
          echo "Testing basic HTTP response..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ Basic HTTP response: $HTTP_CODE"
          else
            echo "❌ Basic HTTP response failed: $HTTP_CODE"
            exit 1
          fi
          
          # Test 2: API endpoint - projects list
          echo "Testing API endpoint: /api/projects..."
          API_RESPONSE=$(curl -s http://127.0.0.1:8080/api/projects)
          if echo "$API_RESPONSE" | grep -q "projects"; then
            echo "✅ API /api/projects responding correctly"
          else
            echo "❌ API /api/projects failed"
            echo "Response: $API_RESPONSE"
            exit 1
          fi
          
          # Test 3: API health check
          echo "Testing API health..."
          HEALTH_RESPONSE=$(curl -s http://127.0.0.1:8080/api/health 2>/dev/null || curl -s http://127.0.0.1:8080)
          if [ -n "$HEALTH_RESPONSE" ]; then
            echo "✅ API health check passed"
          else
            echo "❌ API health check failed"
            exit 1
          fi
          
          echo "✅ All API tests passed on ${{ matrix.os }}"
          exit 0
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.artifact_name }}${{ runner.os == 'Windows' && '.exe' || '' }}
