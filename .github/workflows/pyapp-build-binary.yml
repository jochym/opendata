name: Build pyApp Binary

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      artifact_name:
        required: true
        type: string
      target:
        required: true
        type: string
    secrets:
      GOOGLE_CLIENT_ID:
        required: false
      GOOGLE_CLIENT_SECRET:
        required: false

jobs:
  build:
    name: Build pyApp (${{ inputs.os }})
    runs-on: ${{ inputs.os }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install System Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb python3-tk libxcb-xinerama0 libxcb-cursor0 binutils
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ inputs.target == 'macos-x86_64' && 'x86_64-apple-darwin' || '' }}
      
      - name: Get PyApp Source
        shell: bash
        run: |
          # Pin to specific PyApp version for reproducibility and security
          PYAPP_VERSION="v0.29.0"
          curl -L "https://github.com/ofek/pyapp/releases/download/${PYAPP_VERSION}/source.tar.gz" -o pyapp-source.tar.gz
          tar -xzf pyapp-source.tar.gz
          mv pyapp-v* pyapp-latest
          cd pyapp-latest
          echo "PYAPP_DIR=$(pwd)" >> $GITHUB_ENV
          echo "PYAPP_VERSION=${PYAPP_VERSION}" >> $GITHUB_ENV
      
      - name: Get Version
        id: version
        shell: bash
        run: |
          # Use clean version from VERSION file (must exist on PyPI)
          VERSION=$(cat src/opendata/VERSION | sed 's/+.*//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      # STEP 1: Build wheel with secrets
      - name: Prepare client_secrets.json
        shell: bash
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          if [ -n "$GOOGLE_CLIENT_ID" ] && [ -n "$GOOGLE_CLIENT_SECRET" ]; then
            echo "{\"installed\":{\"client_id\":\"$GOOGLE_CLIENT_ID\",\"project_id\":\"opendata-tool\",\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\"token_uri\":\"https://oauth2.googleapis.com/token\",\"auth_provider_x509_cert_url\":\"https://www.googleapis.com/oauth2/v1/certs\",\"client_secret\":\"$GOOGLE_CLIENT_SECRET\",\"redirect_uris\":[\"http://localhost\"]}}" > src/opendata/client_secrets.json
          else
            echo "{}" > src/opendata/client_secrets.json
          fi
      
      - name: Build Wheel with Secrets
        id: build_wheel
        shell: bash
        run: |
          # Build wheel that includes client_secrets.json
          pip install build
          python -m build --wheel
          
          # Get wheel filename
          WHEEL_FILE=$(ls dist/*.whl | head -n 1 | xargs basename)
          echo "WHEEL_FILE=$WHEEL_FILE" >> $GITHUB_OUTPUT
          echo "✅ Built wheel: dist/$WHEEL_FILE"
      
      # STEP 2: Test wheel
      - name: Test Wheel Installation
        shell: bash
        run: |
          # Create test venv and install wheel
          python -m venv test_venv
          source test_venv/bin/activate
          
          # Install the wheel
          pip install dist/${{ steps.build_wheel.outputs.WHEEL_FILE }}
          
          # Test that opendata module is importable
          python -c "import opendata; print('✅ opendata module imported successfully')"
          
          # Test that client_secrets.json is included
          python -c "from opendata.utils import get_resource_path; p = get_resource_path('src/opendata/client_secrets.json'); print(f'✅ client_secrets.json found at: {p}'); assert p.exists(), 'File not found'"
          
          # Test version
          python -c "from opendata.utils import get_app_version; v = get_app_version(); print(f'✅ Version: {v}'); assert v != '0.0.0', 'Version not found'"
          
          echo "✅ Wheel tests passed"
      
      # STEP 3: Build pyApp from wheel
      - name: Build with PyApp
        shell: bash
        run: |
          cd pyapp-latest
          mkdir -p ../dist_bin
          
          # Copy wheel to pyapp-latest directory for easier access
          cp ../dist/${{ steps.build_wheel.outputs.WHEEL_FILE }} .
          
          # Set PyApp configuration
          export PYAPP_PROJECT_NAME="opendata-tool"
          # Point to wheel file in current directory
          export PYAPP_PROJECT_PATH="./${{ steps.build_wheel.outputs.WHEEL_FILE }}"
          export PYAPP_EXEC_MODULE="opendata.main"
          export PYAPP_EXEC_FUNCTION="main"
          export PYAPP_PYTHON_VERSION="3.11"
          
          echo "✅ Building from wheel: $PYAPP_PROJECT_PATH"
          
          VERSION=$(cat ../src/opendata/VERSION | sed 's/+.*//')
          
          # Cross-platform build
          if [[ "${{ inputs.target }}" == "macos-x86_64" ]]; then
            cargo build --release --target x86_64-apple-darwin
            cp target/x86_64-apple-darwin/release/pyapp ../dist_bin/${{ inputs.artifact_name }}-$VERSION
          elif [[ "${{ inputs.target }}" == "macos-arm64" ]]; then
            cargo build --release
            cp target/release/pyapp ../dist_bin/${{ inputs.artifact_name }}-$VERSION
          elif [[ "${{ inputs.target }}" == "linux-x86_64" ]]; then
            cargo build --release
            cp target/release/pyapp ../dist_bin/${{ inputs.artifact_name }}-$VERSION
          elif [[ "${{ inputs.target }}" == "windows-x86_64" ]]; then
            cargo build --release
            cp target/release/pyapp.exe ../dist_bin/${{ inputs.artifact_name }}-$VERSION.exe
          fi
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: dist_bin/*
