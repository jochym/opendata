name: Build pyApp Binary

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      artifact_name:
        required: true
        type: string
      target:
        required: true
        type: string
      wheel_file:
        required: true
        type: string
    secrets:
      GOOGLE_CLIENT_ID:
        required: false
      GOOGLE_CLIENT_SECRET:
        required: false

jobs:
  build:
    name: Build pyApp (${{ inputs.os }})
    runs-on: ${{ inputs.os }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel-package
          path: dist/
      
      - name: Verify Rust
        shell: bash
        run: |
          rustc --version || (echo "Rust not found!" && exit 1)
          cargo --version || (echo "Cargo not found!" && exit 1)
      
      - name: Add macOS Intel Target (if needed)
        if: inputs.target == 'macos-x86_64'
        shell: bash
        run: |
          rustup target add x86_64-apple-darwin
      
      - name: Get PyApp Source
        shell: bash
        run: |
          PYAPP_VERSION="v0.29.0"
          curl -L "https://github.com/ofek/pyapp/releases/download/${PYAPP_VERSION}/source.tar.gz" -o pyapp-source.tar.gz
          tar -xzf pyapp-source.tar.gz
          mv pyapp-v* pyapp-latest
          cd pyapp-latest
          echo "PYAPP_DIR=$(pwd)" >> $GITHUB_ENV
          echo "PYAPP_VERSION=${PYAPP_VERSION}" >> $GITHUB_ENV
      
      - name: Get Version
        id: version
        shell: bash
        run: |
          VERSION=$(cat src/opendata/VERSION | sed 's/+.*//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      # STEP 1: Verify wheel (already tested in build-wheel job)
      - name: Verify Wheel
        shell: bash
        run: |
          ls -la dist/
          echo "‚úÖ Using wheel: ${{ inputs.wheel_file }}"
      
      # STEP 2: Build pyApp from wheel
      - name: Build with PyApp
        shell: bash
        run: |
          cd pyapp-latest
          mkdir -p ../dist_bin
          
          # Copy wheel to pyapp-latest directory and get absolute path
          cp ../dist/${{ inputs.wheel_file }} .
          WHEEL_ABS_PATH="$(pwd)/${{ inputs.wheel_file }}"
          
          # DEBUG: Verify wheel file exists BEFORE path conversion
          echo "üîç Verifying wheel file before path conversion..."
          ls -la "${{ inputs.wheel_file }}"
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            WHEEL_SIZE=$(powershell -Command "(Get-Item '${{ inputs.wheel_file }}').Length")
            echo "  Wheel size (Unix path): $WHEEL_SIZE bytes"
          else
            WHEEL_SIZE=$(stat -c%s "${{ inputs.wheel_file }}" 2>/dev/null || stat -f%z "${{ inputs.wheel_file }}" 2>/dev/null || echo "unknown")
            echo "  Wheel size: $WHEEL_SIZE bytes"
          fi
          
          # CRITICAL WINDOWS FIX: Convert Unix-style path to Windows-style for Rust/Windows
          # Git Bash on Windows returns /d/a/... but Rust PathBuf needs D:\a\...
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "ü™ü Windows detected - converting path for Rust/Windows compatibility"
            echo "  Before: $WHEEL_ABS_PATH"
            if command -v cygpath &> /dev/null; then
              WHEEL_ABS_PATH="$(cygpath -w "$WHEEL_ABS_PATH")"
              echo "  After (cygpath): $WHEEL_ABS_PATH"
            else
              # Fallback: manual conversion (shouldn't be needed on GH Actions Windows)
              WHEEL_ABS_PATH="$(echo "$WHEEL_ABS_PATH" | sed 's|^/d/|D:\\|; s|/|\\|g')"
              echo "  After (fallback): $WHEEL_ABS_PATH"
            fi
            
            # CRITICAL: Verify file exists at converted Windows path
            echo "üîç Verifying file exists at Windows path..."
            if powershell -Command "Test-Path '$WHEEL_ABS_PATH'"; then
              WIN_SIZE=$(powershell -Command "(Get-Item '$WHEEL_ABS_PATH').Length")
              echo "  ‚úÖ File exists at Windows path, size: $WIN_SIZE bytes"
            else
              echo "  ‚ùå ERROR: File does NOT exist at converted Windows path!"
              echo "  Looking for: $WHEEL_ABS_PATH"
              POWERSHELL_DIR=$(powershell -Command "Split-Path -Parent '$WHEEL_ABS_PATH'")
              echo "  Directory contents:"
              powershell -Command "Get-ChildItem '$POWERSHELL_DIR'"
              exit 1
            fi
          fi
          
          # Set PyApp configuration
          # CRITICAL: Set NAME and VERSION explicitly so PyApp doesn't try to download from PyPI
          export PYAPP_PROJECT_NAME="opendata-tool"
          export PYAPP_PROJECT_VERSION="0.22.28"
          export PYAPP_PROJECT_PATH="$WHEEL_ABS_PATH"
          export PYAPP_EXEC_MODULE="opendata.main"
          export PYAPP_PYTHON_VERSION="3.11"
          
          echo "‚úÖ PyApp config:"
          echo "  PROJECT_NAME=$PYAPP_PROJECT_NAME"
          echo "  PROJECT_VERSION=$PYAPP_PROJECT_VERSION"
          echo "  PROJECT_PATH=$PYAPP_PROJECT_PATH"
          echo "  EXEC_MODULE=$PYAPP_EXEC_MODULE"
          
          # CRITICAL: Embed Python distribution to avoid runtime downloads
          export PYAPP_DISTRIBUTION_EMBED="true"
          
          # CRITICAL: Use v1 CPU variant for Linux (no AVX2 required)
          # Default v3 requires AVX2 which causes "illegal instruction" on older CPUs
          # Note: VARIANT_CPU only works on Linux, not macOS/Windows
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            export PYAPP_DISTRIBUTION_VARIANT_CPU="v1"
          fi
          
          # Speed up installation by using only binary wheels
          export PYAPP_PIP_EXTRA_ARGS="--only-binary :all:"
          
          echo "‚úÖ Building from wheel: $PYAPP_PROJECT_PATH"
          ls -la "$PYAPP_PROJECT_PATH"
          
          VERSION=$(cat ../src/opendata/VERSION | sed 's/+.*//')
          
          # Cross-platform build
          if [[ "${{ inputs.target }}" == "macos-x86_64" ]]; then
            cargo build --release --target x86_64-apple-darwin
            cp target/x86_64-apple-darwin/release/pyapp ../dist_bin/${{ inputs.artifact_name }}-$VERSION
          elif [[ "${{ inputs.target }}" == "macos-arm64" ]]; then
            cargo build --release
            cp target/release/pyapp ../dist_bin/${{ inputs.artifact_name }}-$VERSION
          elif [[ "${{ inputs.target }}" == "linux-x86_64" ]]; then
            cargo build --release
            cp target/release/pyapp ../dist_bin/${{ inputs.artifact_name }}-$VERSION
          elif [[ "${{ inputs.target }}" == "windows-x86_64" ]]; then
            cargo build --release
            cp target/release/pyapp.exe ../dist_bin/${{ inputs.artifact_name }}-$VERSION.exe
          fi
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: dist_bin/*
