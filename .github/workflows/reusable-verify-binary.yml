name: Verify Binary

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
      artifact_name:
        required: true
        type: string

jobs:
  verify:
    name: Verify (${{ inputs.os }})
    runs-on: ${{ inputs.os }}
    steps:
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: verify-bin
      
      - name: Install Test Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget
      
      - name: Verify HTTP Tools Available
        run: |
          command -v curl || (echo "âŒ curl not found!" && exit 1)
          echo "âœ… curl is available"

      - name: Run Binary and Verify
        shell: bash
        run: |
          BIN_DIR="verify-bin"
          echo "Checking directory: $BIN_DIR"
          ls -R "$BIN_DIR"
          
          # Find the binary in the directory
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            BIN_PATH=$(find "$BIN_DIR" -maxdepth 2 -name "*.exe" | head -n 1)
          else
            BIN_PATH=$(find "$BIN_DIR" -maxdepth 2 -type f -not -name "*.whl" -not -name "*.json" | head -n 1)
          fi
          
          if [ -z "$BIN_PATH" ]; then
            echo "âŒ No binary found in $BIN_DIR"
            exit 1
          fi
          
          echo "Found binary at: $BIN_PATH"
          chmod +x "$BIN_PATH" || true
          
          # STEP 1: Smoke Test (--version)
          # This verifies the binary is not corrupted and architecture is correct.
          # For pyApp, this also triggers the initial dependency installation.
          echo "ðŸš€ STEP 1: Smoke Test (--version)..."
          # Give it 90 seconds because pyApp installs dependencies on first run
          # Use a cross-platform way to handle timeout
          "$BIN_PATH" --version > /tmp/version.log 2>&1 &
          SMOKE_PID=$!
          
          # Wait for smoke test with manual timeout
          COUNT=0
          while kill -0 $SMOKE_PID 2>/dev/null; do
            if [ $COUNT -ge 90 ]; then
              echo "âŒ Smoke test timed out after 90s"
              kill -9 $SMOKE_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
            COUNT=$((COUNT+1))
          done
          wait $SMOKE_PID
          SMOKE_EXIT=$?
          
          if [ $SMOKE_EXIT -ne 0 ]; then
            echo "âŒ Smoke test failed (Exit code: $SMOKE_EXIT)"
            cat /tmp/version.log
            if grep -q "Illegal instruction" /tmp/version.log; then
              echo "  Detected Architecture Mismatch (Illegal Instruction)"
            elif grep -q "ModuleNotFoundError" /tmp/version.log; then
              echo "  Detected Missing Module (Build Configuration Issue)"
            fi
            exit 1
          fi
          echo "âœ… Smoke test passed"
          
          # STEP 2: Functional Test (API)
          echo "ðŸš€ STEP 2: Functional Test (API)..."
          echo "Starting binary in headless mode..."
          nohup "$BIN_PATH" --headless --no-browser --port 8080 --api > /tmp/binary.log 2>&1 &
          BIN_PID=$!
          disown $BIN_PID
          
          # Determine HTTP tool
          HTTP_GET="curl -s --retry 3 --retry-delay 2"
          API_URL="http://127.0.0.1:8080/api/projects"
          
          echo "Waiting for API to respond (up to 60 seconds)..."
          for i in {1..15}; do
            echo "  Attempt $i/15..."
            API_RESPONSE=$($HTTP_GET "$API_URL" 2>&1 || echo "FAILED")
            
            if echo "$API_RESPONSE" | grep -q "projects"; then
              echo "âœ… API is working on ${{ inputs.os }}"
              kill $BIN_PID 2>/dev/null || true
              exit 0
            fi
            
            # Check if process died
            if ! kill -0 $BIN_PID 2>/dev/null; then
              echo "âŒ Binary died during API test"
              cat /tmp/binary.log
              exit 1
            fi
            
            sleep 4
          done
          
          echo "âŒ API failed after timeout"
          echo "Final response: $API_RESPONSE"
          echo "=== Binary log ==="
          tail -50 /tmp/binary.log
          kill $BIN_PID 2>/dev/null || true
          exit 1
